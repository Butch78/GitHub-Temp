{
  "ProjectId": 1,
  "ProjectName": "Matthew-Project",
  "JobName": "Shazeed Python File Import",
  "Logging": 1,
  "LogBatchSize": 5,
  "CancelJobFlag": false,
  "LoggingType": null,
  "Tasks": [
    {
      "JobName": "Shazeed Python File Import",
      "TaskContent": "@\"\r\nWrite-Output 'Start Script: SaveEMBlobToLocal';\r\nIf(-not(Get-InstalledModule Az -ErrorAction silentlycontinue)){\r\n Install-Module Az -Confirm:`$False -Force\r\n}\r\n\r\n\r\nImport-Module Az;\r\n`$secret = ConvertTo-SecureString '8a6f6ff7-8510-4117-a6ed-5fbae91506bb' -AsPlainText -Force;\r\n`$credential = New-Object System.Management.Automation.PSCredential ('bfffd78f-2daa-48fa-84b7-50f4a3ae35c5', `$secret);\r\nConnect-AzAccount -Credential `$credential -ServicePrincipal -Tenant '9aee26d8-97c2-4fad-8900-96735f6dc73f';\r\n\r\n[string]`$subscriptionId = \"733ac4c3-3b03-41dc-8943-30605f63e014\";\r\n[string]`$azureUrl =\"https://genomicsblobstorage.blob.core.windows.net/\";\r\n[string]`$key = \"F9FkJPLpPpd7VIhME9DJq1xm0Azw0OwZV4/vD6lNww3z3+K21MAjy6xTMzr8RsFx8LcPu6r8hGA1aqZBwVAsCg==\";\r\n[string]`$resourceGroup = \"LTU-ICT-Costings\";\r\n[string]`$tenantID = \"9aee26d8-97c2-4fad-8900-96735f6dc73f\";\r\n[string]`$storageAccount = \"genomicsblobstorage\";\r\n[string]`$dropzoneName = \"dropzone-expressionmatrix\";\r\n[string]`$originalfileContainer = \"orgfiles-expressionmatrix\";\r\n\r\n`$context = New-AzStorageContext -StorageAccountName `$storageAccount -StorageAccountKey `$key;\r\n`$ctx = `$context.Context;\r\n\r\n`$docs = Get-AzStorageBlob -Context `$ctx -Container `$dropzoneName;\r\nforeach(`$doc in `$docs){\r\n    Start-AzStorageBlobCopy -SrcBlob `$doc.Name -DestContainer `$originalfileContainer -SrcContainer `$dropzoneName -Context `$ctx -Force\r\n\r\n    if (Test-Path -LiteralPath '.\\TempExMatrxAgriBio' -PathType Container) {Remove-Item -path '.\\TempExMatrxAgriBio' -recurse}\r\n    New-Item -Path \".\\\" -Name \"TempExMatrxAgriBio\" -ItemType \"directory\" \r\n    `$file = Get-AzStorageBlobContent -Context `$ctx -Container `$dropzoneName -Blob `$doc.Name -Destination \".\\TempExMatrxAgriBio\\\"\r\n}\r\nWrite-Output 'End Script: SaveEMBlobToLocal';\r\n\"@| Out-File SaveEMBlobToLocal.ps1\r\npwsh SaveEMBlobToLocal.ps1",
      "TaskName": "SaveEMBlobToLocal",
      "ProjectId": 1,
      "ProjectName": null,
      "TaskTypeName": "PowerShell Core",
      "Logging": 1,
      "LastEndPoint": null,
      "PendingEndPoint": null,
      "ParameterNames": "",
      "ParameterDefaults": "",
      "SourceSchema": null,
      "TargetSchema": null,
      "SourceConnectionName": null,
      "TargetConnectionName": null,
      "SourceFileName": null,
      "TargetFileName": null,
      "SourceClusterName": null,
      "TargetClusterName": null,
      "SourceFileId": null,
      "TargetFileId": null,
      "MaxThreads": 4,
      "ParallelDm": true,
      "PythonEnvironmentName": null,
      "RunWithAgentId": 1,
      "Agent": {
        "AgentId": 1,
        "AgentName": "BizData-L145.bizdata.local",
        "HostName": "BizData-L145.bizdata.local",
        "DateCreated": "0001-01-01T00:00:00",
        "DateUpdated": "0001-01-01T00:00:00",
        "HeartBeat": "0001-01-01T00:00:00",
        "Version": null,
        "TaskQueues": null,
        "ConnectionId": null,
        "IsHealthy": false
      },
      "PythonEnvironment": null,
      "SourceConnection": null,
      "TargetConnection": null,
      "SourceCluster": null,
      "TargetCluster": null,
      "LoggingType": null,
      "TaskType": null,
      "TaskTable": [],
      "TaskConnections": []
    },
    {
      "JobName": "Shazeed Python File Import",
      "TaskContent": "import os\r\nimport pandas as pd\r\nimport setuptools\r\nfrom azure.storage.blob import BlockBlobService\r\n\r\ninput_file_direc = '/app/TempExMatrxAgriBio'\r\naccountName = \"genomicsblobstorage\"\r\naccountKey = \"F9FkJPLpPpd7VIhME9DJq1xm0Azw0OwZV4/vD6lNww3z3+K21MAjy6xTMzr8RsFx8LcPu6r8hGA1aqZBwVAsCg==\"\r\ncontainerName = \"pivoted-expressionmatrix\"\r\n\r\nblobService = BlockBlobService(account_name=accountName, account_key=accountKey)\r\n\r\n\r\nchunk_size = 10\r\nif(os.path.isdir(input_file_direc)):\r\n    print('Input Directory found')\r\n    for r, d, f in os.walk(input_file_direc):\r\n        for file in f:\r\n            if \".csv\" in file:\r\n                input_file_path = os.path.join(r, file)\r\n                input_file_name = os.path.basename(input_file_path)\r\n                print(str(input_file_name) +' is being processed')\r\n                data = pd.read_csv(input_file_path)\r\n                df = pd.DataFrame(data)\r\n                part = 1\r\n                for i in range(0,len(df),chunk_size):\r\n                    onedf =df.iloc[i:i+chunk_size].melt(id_vars = ['GeneID'], var_name = 'Cell_barcode', value_name = 'Expression Value')\r\n                    print(len(onedf))\r\n                    #df_unpivoted = df.melt(id_vars = ['Gene'], var_name = 'Cell_barcode', value_name = 'Expression Value')\r\n                    out_file_name ='pivoted_' + str(os.path.splitext(input_file_name)[0]) + \"_\"+ str(part) + \".csv\"\r\n                    output_csv = onedf.to_csv (index=False, encoding = \"utf-8\")\r\n                    print(out_file_name)\r\n                    blobService = BlockBlobService(account_name=accountName, account_key=accountKey)\r\n                    print(blobService)\r\n                    blobService.create_blob_from_text(containerName, out_file_name, output_csv)\r\n                    part = part + 1",
      "TaskName": "MemEff_ProcessCSV",
      "ProjectId": 1,
      "ProjectName": null,
      "TaskTypeName": "Python",
      "Logging": 1,
      "LastEndPoint": null,
      "PendingEndPoint": null,
      "ParameterNames": "",
      "ParameterDefaults": "",
      "SourceSchema": null,
      "TargetSchema": null,
      "SourceConnectionName": null,
      "TargetConnectionName": null,
      "SourceFileName": null,
      "TargetFileName": null,
      "SourceClusterName": null,
      "TargetClusterName": null,
      "SourceFileId": null,
      "TargetFileId": null,
      "MaxThreads": 4,
      "ParallelDm": true,
      "PythonEnvironmentName": "Python3",
      "RunWithAgentId": 1,
      "Agent": {
        "AgentId": 1,
        "AgentName": "BizData-L145.bizdata.local",
        "HostName": "BizData-L145.bizdata.local",
        "DateCreated": "0001-01-01T00:00:00",
        "DateUpdated": "0001-01-01T00:00:00",
        "HeartBeat": "0001-01-01T00:00:00",
        "Version": null,
        "TaskQueues": null,
        "ConnectionId": null,
        "IsHealthy": false
      },
      "PythonEnvironment": null,
      "SourceConnection": null,
      "TargetConnection": null,
      "SourceCluster": null,
      "TargetCluster": null,
      "LoggingType": null,
      "TaskType": null,
      "TaskTable": [],
      "TaskConnections": []
    },
    {
      "JobName": "Shazeed Python File Import",
      "TaskContent": "  DROP INDEX IF EXISTS [NCIX_EXP_MAT] ON [dbo].[ExpressionMatrix]",
      "TaskName": "Drop ColumnStore_Index",
      "ProjectId": 1,
      "ProjectName": null,
      "TaskTypeName": "SQL Statement",
      "Logging": 1,
      "LastEndPoint": null,
      "PendingEndPoint": null,
      "ParameterNames": "",
      "ParameterDefaults": "",
      "SourceSchema": null,
      "TargetSchema": null,
      "SourceConnectionName": "Warehouse",
      "TargetConnectionName": null,
      "SourceFileName": null,
      "TargetFileName": null,
      "SourceClusterName": null,
      "TargetClusterName": null,
      "SourceFileId": null,
      "TargetFileId": null,
      "MaxThreads": 4,
      "ParallelDm": true,
      "PythonEnvironmentName": null,
      "RunWithAgentId": 1,
      "Agent": {
        "AgentId": 1,
        "AgentName": "BizData-L145.bizdata.local",
        "HostName": "BizData-L145.bizdata.local",
        "DateCreated": "0001-01-01T00:00:00",
        "DateUpdated": "0001-01-01T00:00:00",
        "HeartBeat": "0001-01-01T00:00:00",
        "Version": null,
        "TaskQueues": null,
        "ConnectionId": null,
        "IsHealthy": false
      },
      "PythonEnvironment": null,
      "SourceConnection": null,
      "TargetConnection": null,
      "SourceCluster": null,
      "TargetCluster": null,
      "LoggingType": null,
      "TaskType": null,
      "TaskTable": [],
      "TaskConnections": []
    },
    {
      "JobName": "Shazeed Python File Import",
      "TaskContent": "",
      "TaskName": "MigratePivotedFiles",
      "ProjectId": 1,
      "ProjectName": null,
      "TaskTypeName": "Data Migration",
      "Logging": 1,
      "LastEndPoint": null,
      "PendingEndPoint": null,
      "ParameterNames": "FlatFileDetectDataTypeMaxRow|UseTableDetect|DetectFilter",
      "ParameterDefaults": "0|true|",
      "SourceSchema": null,
      "TargetSchema": "pv",
      "SourceConnectionName": "TestZoneStorage-Connection",
      "TargetConnectionName": "Warehouse",
      "SourceFileName": "Pivoted-ExpressionMatrix",
      "TargetFileName": null,
      "SourceClusterName": null,
      "TargetClusterName": null,
      "SourceFileId": null,
      "TargetFileId": null,
      "MaxThreads": 2,
      "ParallelDm": true,
      "PythonEnvironmentName": null,
      "RunWithAgentId": 1,
      "Agent": {
        "AgentId": 1,
        "AgentName": "BizData-L145.bizdata.local",
        "HostName": "BizData-L145.bizdata.local",
        "DateCreated": "0001-01-01T00:00:00",
        "DateUpdated": "0001-01-01T00:00:00",
        "HeartBeat": "0001-01-01T00:00:00",
        "Version": null,
        "TaskQueues": null,
        "ConnectionId": null,
        "IsHealthy": false
      },
      "PythonEnvironment": null,
      "SourceConnection": null,
      "TargetConnection": null,
      "SourceCluster": null,
      "TargetCluster": null,
      "LoggingType": null,
      "TaskType": null,
      "TaskTable": [
        {
          "SourceSchemaName": "",
          "SourceTableName": "pivoted_scRNAseq_raw_expressions_matrix_03022020_1.csv",
          "TargetSchemaName": "pv",
          "TargetTableName": "pivoted_scRNAseq_raw_expressions_matrix_03022020_1.csv",
          "Sequence": 1,
          "DataCurrencyDatabase": null,
          "DataCurrencySchema": null,
          "DataCurrencyTable": null,
          "DataCurrencyColumnName": null,
          "RefreshPeriod": 1,
          "RefreshPeriodTypeId": 1,
          "IsIncremental": false,
          "TruncateOnReload": null,
          "ImportPrimaryKeys": false,
          "ImportSecondaryIndexes": false,
          "Query": null,
          "LastEndPoint": "",
          "ColumnStore": null,
          "FileGroup": null,
          "SpaceReplacement": null,
          "TaskTableColumns": [],
          "TaskTableColumnFilters": [],
          "TaskTableExtendedOptions": [],
          "TaskMerges": [],
          "RefreshPeriodType": "Day"
        }
      ],
      "TaskConnections": []
    }
  ],
  "JobSequences": [
    {
      "JobName": "Shazeed Python File Import",
      "RunSequence": 1,
      "ParallelSequence": 0,
      "ParameterValues": null,
      "ConnectionId": null,
      "Active": true,
      "TaskName": "SaveEMBlobToLocal",
      "Connection": null
    },
    {
      "JobName": "Shazeed Python File Import",
      "RunSequence": 2,
      "ParallelSequence": 0,
      "ParameterValues": null,
      "ConnectionId": null,
      "Active": true,
      "TaskName": "MemEff_ProcessCSV",
      "Connection": null
    },
    {
      "JobName": "Shazeed Python File Import",
      "RunSequence": 3,
      "ParallelSequence": 0,
      "ParameterValues": null,
      "ConnectionId": null,
      "Active": true,
      "TaskName": "Drop ColumnStore_Index",
      "Connection": null
    },
    {
      "JobName": "Shazeed Python File Import",
      "RunSequence": 4,
      "ParallelSequence": 0,
      "ParameterValues": null,
      "ConnectionId": null,
      "Active": true,
      "TaskName": "MigratePivotedFiles",
      "Connection": null
    }
  ],
  "JobSequenceDependencies": [],
  "JobDependencies": []
}